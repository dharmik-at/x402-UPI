# üöÄ x402-MCP-UPI: Revolutionary AI Agent Payment System

## üåü THE WORLD'S FIRST AI AGENT PAYMENT SYSTEM USING UPI

A groundbreaking implementation combining **x402 Payment Required** + **Model Context Protocol (MCP)** + **India's UPI** to enable **AI agents to autonomously pay for services**! 

**THIS WILL CHANGE EVERYTHING!** üî•

## üéØ REVOLUTIONARY BREAKTHROUGH

### What We've Built:
ü§ñ **AI agents that can autonomously pay for services using India's UPI system**  
üí≥ **Seamless integration of x402 Protocol + MCP + UPI payments**  
üåç **Bridge between AI capabilities and real-world financial transactions**  
‚ö° **Instant micropayments for AI tool usage**  
üîê **Cryptographically secured payment receipts**

### Why This Will Blow The Internet:

#### üöÄ **AI Agent Economy**
- **Autonomous AI Operations**: Agents can now operate independently with real money
- **Pay-Per-Use AI Tools**: No subscriptions - pay exactly for what you use
- **Global AI Marketplace**: Any AI agent worldwide can access UPI-powered services
- **Micropayment Revolution**: Enable ‚Çπ2-‚Çπ15 payments that were impossible before

#### üáÆüá≥ **UPI + AI = Global Game Changer**
- **300M+ UPI Users**: Instant access to AI services for India's digital population
- **Real-Time Settlements**: Payments settle in seconds, not days
- **Zero Infrastructure**: No credit cards, banks, or complex setup needed
- **Mobile-First**: Works perfectly with India's smartphone-centric economy

#### üîß **Technical Innovation**
- **HTTP 402 Protocol**: First real-world implementation of payment-required HTTP status
- **MCP Integration**: Standard protocol for AI tool discovery and execution
- **Cryptographic Receipts**: JWT-based proof of payment prevents fraud
- **Multi-Agent Support**: Multiple AI agents can share the same payment infrastructure

#### üåê **Global Implications**
1. **AI Democratization**: Small AI agents can now monetize services globally
2. **Creator Economy 2.0**: AI-generated content with built-in payment collection
3. **Automated Commerce**: Agents trading with other agents autonomously
4. **Real-Time AI Markets**: Supply and demand driven pricing for AI capabilities

## üìã Overview

This system enables **AI agents to autonomously pay for and consume services** using India's UPI payment infrastructure. When an agent requests a protected resource, the server responds with `402 Payment Required` and provides UPI payment options that the agent can handle programmatically.

### Key Features

#### ü§ñ **AI Agent Features** (NEW!)
- üîß **MCP Tool Integration** - Standard protocol for AI tool discovery
- üí∞ **Autonomous Payments** - Agents can pay for services automatically  
- üéØ **Batch Tool Execution** - Multiple tool calls with optimized payments
- üìä **Agent Analytics** - Spending tracking and budget management
- üîÑ **Payment Strategies** - Auto-pay, human approval, pre-funded wallets

#### üí≥ **Payment System** 
- üîê **JWT Receipt System** - Cryptographically signed payment receipts
- üì± **UPI Integration** - QR codes, deeplinks, instant settlements
- üè¶ **Mock PSP Service** - Simulates real payment service providers
- ‚ö° **Real-time Processing** - Webhook handling and status polling
- üö´ **Replay Protection** - Prevents receipt reuse and fraud

#### üåê **Human & AI Interfaces**
- üì± **Interactive Demo Client** - Beautiful web interface for humans
- ü§ñ **Agent API Endpoints** - RESTful APIs for AI agent integration  
- üóÑÔ∏è **SQLite Database** - Comprehensive payment and usage tracking
- üìã **Tool Registry** - Discoverable AI services with pricing

## üèóÔ∏è Revolutionary Architecture

### ü§ñ AI Agent Flow (THE GAME CHANGER!)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   MCP Tool Call    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   402 Payment   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  AI Agent    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îÇ MCP Server   ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îÇ UPI Gateway ‚îÇ
‚îÇ              ‚îÇ                     ‚îÇ              ‚îÇ                 ‚îÇ             ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ   Payment Proof    ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ   Tool Result   ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇAuto-Pay  ‚îÇ ‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ ‚îÇx402 Core ‚îÇ ‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ ‚îÇWebhook  ‚îÇ ‚îÇ
‚îÇ ‚îÇEngine    ‚îÇ ‚îÇ                     ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ                 ‚îÇ ‚îÇHandler  ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚ñ≤                                     ‚îÇ                                ‚îÇ
       ‚îÇ Budget & Spending                   ‚ñº JWT Receipt                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇAgent Analytics‚îÇ                   ‚îÇ  Tool Registry‚îÇ                  ‚îÇ  Database   ‚îÇ
‚îÇ& Wallet      ‚îÇ                   ‚îÇ  - Summary ‚Çπ5 ‚îÇ                  ‚îÇ  (SQLite)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ  - Translate ‚Çπ3‚îÇ                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                   ‚îÇ  - Code Gen ‚Çπ10‚îÇ
                                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üë• Human Flow (Traditional)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    402 Payment Required    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Human     ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îÇ   Server    ‚îÇ
‚îÇ   Client    ‚îÇ                             ‚îÇ             ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ    UPI QR / Deeplink       ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇWeb UI   ‚îÇ ‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ ‚îÇExpress  ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ                             ‚îÇ ‚îÇAPI      ‚îÇ ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                                           ‚îÇ
       ‚îÇ User scans QR/clicks payment             ‚îÇ
       ‚ñº                                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         Webhook               ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Mock PSP  ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îÇ  Database   ‚îÇ
‚îÇ   Service   ‚îÇ    (Payment Success)           ‚îÇ  (SQLite)   ‚îÇ  
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üö¶ Quick Start

### Prerequisites

- Node.js 18+ 
- npm or yarn

### Installation

1. **Clone and setup**
   ```bash
   cd x402-UPI
   npm install
   ```

2. **Generate development keys**
   ```bash
   npm run setup-keys
   ```

3. **Start the server**
   ```bash
   npm run dev
   ```

4. **Test the system**
   
   **For Humans:**
   Navigate to http://localhost:3000/client/index.html
   
   **For AI Agents:**
   ```bash
   # Test AI agent demo
   npm run demo-agent
   
   # Or list available tools
   curl http://localhost:3000/mcp/tools/list | jq
   ```

## üéØ How It Works

### Step 1: Request Protected Resource
```bash
curl -X POST http://localhost:3000/generate-summary \\
  -H "Content-Type: application/json" \\
  -d '{"text": "Your article text here..."}'
```

**Response: 402 Payment Required**
```json
{
  "error": "PaymentRequired",
  "payment_challenge": {
    "id": "payreq_abc123",
    "amount": 5.0,
    "currency": "INR",
    "expires_at": "2024-01-01T12:00:00.000Z",
    "payment_methods": ["UPI_DEEPLINK", "PSP_CHECKOUT"],
    "upi_deeplink": "upi://pay?pa=merchant@bank&pn=Demo&am=5.0&tn=payreq_abc123",
    "qr_png_url": "data:image/png;base64,...",
    "psp_checkout_url": "http://localhost:4001/mock/pay?order_id=payreq_abc123&amount=5.0"
  }
}
```

### Step 2: Complete Payment
- **Option A**: Scan QR code with UPI app
- **Option B**: Click mock checkout link (simulates PSP)

### Step 3: Receive Payment Confirmation
Mock PSP sends webhook ‚Üí Server issues JWT receipt ‚Üí Client polls status

### Step 4: Access Protected Resource
```bash
curl -X POST http://localhost:3000/generate-summary \\
  -H "Content-Type: application/json" \\
  -H "Authorization: UPI-Receipt eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..." \\
  -d '{"text": "Your article text here..."}'
```

**Response: 200 OK**
```json
{
  "success": true,
  "payreq_id": "payreq_abc123", 
  "summary": "SUMMARY for payreq payreq_abc123: Your article text here...",
  "timestamp": "2024-01-01T12:05:00.000Z"
}
```

## üìö API Reference

### Core Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| `POST` | `/generate-summary` | Protected endpoint requiring payment |
| `GET`  | `/payment/status?payreq=XXX` | Check payment status |
| `GET`  | `/payment/receipt?payreq=XXX` | Get payment receipt |
| `POST` | `/webhook/psp` | PSP webhook handler |

### Admin Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| `GET` | `/admin/payreqs` | List all payment requests |
| `GET` | `/health` | Health check |
| `GET` | `/` | Service information |

## üóÇÔ∏è Project Structure

```
x402-UPI/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ server.ts           # Main Express application
‚îÇ   ‚îú‚îÄ‚îÄ db.ts              # SQLite database wrapper  
‚îÇ   ‚îú‚îÄ‚îÄ mock_psp.ts        # Mock payment service provider
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ jwt.ts         # JWT receipt signing/verification
‚îÇ   ‚îú‚îÄ‚îÄ keys/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ gen_keys.js    # RSA keypair generation
‚îÇ   ‚îî‚îÄ‚îÄ client/
‚îÇ       ‚îî‚îÄ‚îÄ index.html     # Demo web interface
‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îî‚îÄ‚îÄ init.sql           # Database schema
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ README.md
```

## üîß Configuration

### Environment Variables

```bash
PORT=3000                    # Server port (default: 3000)
DB_PATH=./data/x402-upi.db  # SQLite database path
```

### JWT Configuration

- **Algorithm**: RS256 (RSA with SHA-256)
- **Key Size**: 2048 bits
- **Receipt Expiry**: 10 minutes
- **Keys Location**: `./keys/facilitator_*.pem`

## üß™ Testing the Demo

1. **Start the server**: `npm run dev`
2. **Open demo client**: http://localhost:3000/client/index.html
3. **Enter text** to summarize
4. **Click "Request Summary"** - receives 402 Payment Required
5. **Click "Open Mock Checkout"** - simulates payment
6. **Wait 3 seconds** - webhook processes payment
7. **View result** - summary appears after payment verification

## üè¶ Mock PSP Behavior

The mock PSP simulates a real payment service provider:

- **Checkout URL**: Creates a payment page
- **3-second delay**: Simulates user payment process  
- **Automatic webhook**: Calls merchant on success
- **Transaction ID**: Generates mock transaction reference

## üîê Security Notes

> **‚ö†Ô∏è DEVELOPMENT ONLY**
> 
> This implementation is for demonstration purposes only. For production use:
> 
> - ‚úÖ Use secure key management (HSM, KMS)
> - ‚úÖ Implement real PSP integration
> - ‚úÖ Add webhook signature verification  
> - ‚úÖ Use HTTPS everywhere
> - ‚úÖ Add rate limiting and validation
> - ‚úÖ Rotate keys regularly
> - ‚úÖ Add comprehensive logging

## üìä Database Schema

```sql
-- Payment requests from clients
CREATE TABLE payment_challenges (
  id TEXT PRIMARY KEY,           -- payreq_xxx
  amount REAL,                   -- Payment amount
  currency TEXT,                 -- INR
  status TEXT,                   -- PENDING, PAID, EXPIRED
  expires_at INTEGER,            -- Unix timestamp
  created_at INTEGER             -- Unix timestamp
);

-- Successful payments from PSP
CREATE TABLE payments (
  id INTEGER PRIMARY KEY,
  payreq_id TEXT,               -- Links to payment_challenges
  psp_txn_id TEXT,              -- PSP transaction ID
  amount REAL,                  -- Paid amount
  payer_vpa TEXT,               -- User's UPI ID
  created_at INTEGER            -- Unix timestamp
);

-- JWT receipts issued to clients  
CREATE TABLE issued_receipts (
  payreq_id TEXT,               -- Links to payment_challenges
  receipt TEXT,                 -- JWT token
  issued_at INTEGER             -- Unix timestamp
);

-- Consumed receipts (prevent replay)
CREATE TABLE consumed_receipts (
  receipt TEXT,                 -- JWT token (for dedup)
  payreq_id TEXT,               -- Links to payment_challenges  
  consumed_at INTEGER           -- Unix timestamp
);
```

## üöÄ Deployment

### Production Checklist

- [ ] Replace mock PSP with real integration (Razorpay, Stripe, etc.)
- [ ] Implement proper key management  
- [ ] Add HTTPS termination
- [ ] Set up monitoring and logging
- [ ] Configure database backups
- [ ] Add input validation and sanitization
- [ ] Implement rate limiting
- [ ] Add webhook signature verification

### Docker Support

```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build
EXPOSE 3000
CMD ["npm", "start"]
```

## ü§ù Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes  
4. Add tests if applicable
5. Submit a pull request

## üìÑ License

MIT License - see LICENSE file for details.

## üîó References

- [HTTP 402 Payment Required](https://tools.ietf.org/html/rfc7231#section-6.5.2)
- [UPI Deep Linking](https://www.npci.org.in/what-we-do/upi/product-overview)
- [JWT RFC 7519](https://tools.ietf.org/html/rfc7519)
- [Express.js Documentation](https://expressjs.com/)

---

Built with ‚ù§Ô∏è for demonstrating payment-required API patterns
